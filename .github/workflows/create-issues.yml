name: Create Issues from issues.md

on:
  workflow_dispatch:

permissions:
  issues: write
  contents: read

jobs:
  create_issues:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create issues from markdown
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');

            // Read issues.md safely (handles unicode, quotes, emojis)
            const content = fs.readFileSync('issues.md', 'utf8');
            const lines = content.split("\n");

            let currentTitle = null;
            let currentLabels = [];
            let bodyLines = [];
            const issues = [];

            function pushIssue() {
              if (!currentTitle) return;
              issues.push({
                title: currentTitle.trim(),
                body: bodyLines.join("\n").trim(),
                labels: currentLabels
              });
              currentTitle = null;
              currentLabels = [];
              bodyLines = [];
            }

            for (let line of lines) {
              if (line.startsWith("## ")) {
                pushIssue();
                currentTitle = line.replace("## ", "").trim();
              } else if (line.startsWith("**Labels:**")) {
                const labelText = line.replace("**Labels:**", "").trim();
                currentLabels = labelText
                  .split(",")
                  .map(l => l.trim())
                  .filter(Boolean);
              } else if (line.startsWith("---")) {
                continue;
              } else {
                bodyLines.push(line);
              }
            }
            pushIssue();

            console.log(`Parsed ${issues.length} issues`);

            // Fetch existing issues to avoid duplicates
            const existingTitles = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: "all",
                per_page: 100
              }
            ).then(data => data.map(issue => issue.title));

            console.log("Existing issues:", existingTitles.length);

            for (let issue of issues) {
              if (existingTitles.includes(issue.title)) {
                console.log(`Skipping existing issue: ${issue.title}`);
                continue;
              }

              console.log(`Creating issue: ${issue.title}`);

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issue.title,
                body: issue.body,
                labels: issue.labels
              });
            }

            console.log("Issue creation completed.");
